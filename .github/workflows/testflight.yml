name: TestFlight

on:
  push:
    tags:
      - 'v*-beta'      # e.g., v1.0.0-beta
      - 'v*-rc*'       # e.g., v1.0.0-rc1, v1.0.0-rc2
  workflow_dispatch:

jobs:
  testflight-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Generate TestFlight version
      id: version
      run: |
        BUILD_NUMBER=$(git rev-list --count HEAD)
        COMMIT_SHA=$(git rev-parse --short HEAD)
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          # Manual trigger: use default beta version
          MARKETING_VERSION="1.0.0-beta"
        else
          # Tag trigger: extract from tag (e.g., v1.0.0-beta → 1.0.0-beta)
          MARKETING_VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        echo "version=${MARKETING_VERSION}" >> "$GITHUB_OUTPUT"
        echo "build_number=${BUILD_NUMBER}" >> "$GITHUB_OUTPUT"
        echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"
        
        echo "## TestFlight Version" >> $GITHUB_STEP_SUMMARY
        echo "- Marketing Version: ${MARKETING_VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Number: ${BUILD_NUMBER}" >> $GITHUB_STEP_SUMMARY
        echo "- Display: ${MARKETING_VERSION} (${BUILD_NUMBER})" >> $GITHUB_STEP_SUMMARY
      
    - name: Setup App Store Connect API Key
      run: |
        mkdir -p ~/private_keys
        echo "${{ secrets.APPSTORE_PRIVATE_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
      
    - name: Build and Archive iOS (TestFlight)
      run: |
        xcodebuild archive \
          -project LoRaCueManager.xcodeproj \
          -scheme LoRaCueManager \
          -destination "generic/platform=iOS" \
          -archivePath ./build/LoRaCueManager-iOS-Beta.xcarchive \
          CODE_SIGN_STYLE=Automatic \
          MARKETING_VERSION=${{ steps.version.outputs.version }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
          -allowProvisioningUpdates
      
    - name: Export iOS IPA (TestFlight)
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/LoRaCueManager-iOS-Beta.xcarchive \
          -exportPath ./build/iOS-Beta \
          -exportOptionsPlist .github/workflows/ExportOptions-TestFlight-iOS.plist \
          -allowProvisioningUpdates
      
    - name: Upload iOS to TestFlight
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file ./build/iOS-Beta/LoRaCueManager.ipa \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
        echo "✅ iOS build ${{ steps.version.outputs.build_number }} uploaded to TestFlight"
      
    - name: Build and Archive macOS (TestFlight)
      run: |
        xcodebuild archive \
          -project LoRaCueManager.xcodeproj \
          -scheme LoRaCueManager \
          -destination "generic/platform=macOS" \
          -archivePath ./build/LoRaCueManager-macOS-Beta.xcarchive \
          CODE_SIGN_STYLE=Automatic \
          MARKETING_VERSION=${{ steps.version.outputs.version }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
          -allowProvisioningUpdates
      
    - name: Export macOS PKG (TestFlight)
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/LoRaCueManager-macOS-Beta.xcarchive \
          -exportPath ./build/macOS-Beta \
          -exportOptionsPlist .github/workflows/ExportOptions-TestFlight-macOS.plist \
          -allowProvisioningUpdates
      
    - name: Upload macOS to TestFlight
      run: |
        xcrun altool --upload-app \
          --type macos \
          --file ./build/macOS-Beta/LoRaCueManager.pkg \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
        echo "✅ macOS build ${{ steps.version.outputs.build_number }} uploaded to TestFlight"
      
    - name: Summary
      run: |
        echo "## TestFlight Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Marketing Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number**: ${{ steps.version.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Display**: ${{ steps.version.outputs.version }} (${{ steps.version.outputs.build_number }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ steps.version.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Builds uploaded to TestFlight for beta testing." >> $GITHUB_STEP_SUMMARY
