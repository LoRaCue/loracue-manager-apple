name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    name: Generate Release Notes
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      breaking_changes: ${{ steps.changelog.outputs.breaking_changes }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Generate commit-based changelog
      id: changelog
      run: |
        # Get previous tag
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found, using all commits"
          COMMIT_RANGE="HEAD"
        else
          echo "Generating changelog from $PREV_TAG to HEAD"
          COMMIT_RANGE="$PREV_TAG..HEAD"
        fi
        
        # Parse commits by conventional commit type
        FEATURES=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^feat(\(.+\))?:" | sed 's/^feat[^:]*: /- /' || echo "")
        FIXES=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^fix(\(.+\))?:" | sed 's/^fix[^:]*: /- /' || echo "")
        DOCS=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^docs(\(.+\))?:" | sed 's/^docs[^:]*: /- /' || echo "")
        STYLE=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^style(\(.+\))?:" | sed 's/^style[^:]*: /- /' || echo "")
        PERF=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^perf(\(.+\))?:" | sed 's/^perf[^:]*: /- /' || echo "")
        REFACTOR=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -E "^refactor(\(.+\))?:" | sed 's/^refactor[^:]*: /- /' || echo "")
        OTHER=$(git log "$COMMIT_RANGE" --pretty=format:"%s" --no-merges | grep -vE "^(feat|fix|docs|style|perf|refactor)(\(.+\))?:" | sed 's/^/- /' || echo "")
        
        # Detect breaking changes
        BREAKING=$(git log "$COMMIT_RANGE" --pretty=format:"%s%n%b" --no-merges | grep -A 10 -E "(^[a-z]+(\(.+\))?!:|BREAKING CHANGE:)" | grep -v "^--$" | sed 's/^/- /' || echo "")
        
        # Build changelog
        CHANGELOG=""
        
        if [ -n "$FEATURES" ]; then
          CHANGELOG+="## üöÄ Features"$'\n\n'"$FEATURES"$'\n\n'
        fi
        
        if [ -n "$FIXES" ]; then
          CHANGELOG+="## üêõ Bug Fixes"$'\n\n'"$FIXES"$'\n\n'
        fi
        
        if [ -n "$STYLE" ]; then
          CHANGELOG+="## üé® UI/UX Improvements"$'\n\n'"$STYLE"$'\n\n'
        fi
        
        if [ -n "$PERF" ]; then
          CHANGELOG+="## ‚ö° Performance"$'\n\n'"$PERF"$'\n\n'
        fi
        
        if [ -n "$DOCS" ]; then
          CHANGELOG+="## üìö Documentation"$'\n\n'"$DOCS"$'\n\n'
        fi
        
        if [ -n "$REFACTOR" ]; then
          CHANGELOG+="## üîß Refactoring"$'\n\n'"$REFACTOR"$'\n\n'
        fi
        
        if [ -n "$OTHER" ]; then
          CHANGELOG+="## üìã Other Changes"$'\n\n'"$OTHER"$'\n\n'
        fi
        
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="No changes in this release"
        fi
        
        # Save outputs
        {
          echo "changelog<<EOF"
          echo -e "$CHANGELOG"
          echo "EOF"
          echo "breaking_changes<<EOF"
          echo -e "$BREAKING"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

  build-and-release:
    runs-on: macos-latest
    needs: generate-changelog
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
    - name: Extract version from tag
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          TAG="${{ github.event.inputs.version }}"
        else
          TAG="${GITHUB_REF#refs/tags/v}"
        fi
        # Determine if this is a pre-release based on branch
        BRANCH=$(git branch -r --contains "${{ github.sha }}" | grep -E 'origin/(main|develop)' | sed 's/.*origin\///' | head -1)
        if [ "$BRANCH" = "develop" ]; then
          echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          echo "## Pre-Release: v${TAG}" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          echo "## Production Release: v${TAG}" >> "$GITHUB_STEP_SUMMARY"
        fi
        echo "version=$TAG" >> "$GITHUB_OUTPUT"
        BUILD_NUMBER=$(git rev-list --count HEAD)
        echo "build_number=$BUILD_NUMBER" >> "$GITHUB_OUTPUT"
        echo "Build: ${BUILD_NUMBER}" >> "$GITHUB_STEP_SUMMARY"
        echo "Branch: ${BRANCH}" >> "$GITHUB_STEP_SUMMARY"
      
    - name: Setup App Store Connect API Key
      run: |
        mkdir -p ~/private_keys
        echo "${{ secrets.APPSTORE_PRIVATE_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8
      
    - name: Build and Archive iOS
      run: |
        xcodebuild archive \
          -project LoRaCueManager.xcodeproj \
          -scheme LoRaCueManager \
          -destination "generic/platform=iOS" \
          -archivePath ./build/LoRaCueManager-iOS.xcarchive \
          -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8 \
          -authenticationKeyID ${{ secrets.APPSTORE_KEY_ID }} \
          -authenticationKeyIssuerID ${{ secrets.APPSTORE_ISSUER_ID }} \
          MARKETING_VERSION=${{ steps.version.outputs.version }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
          -allowProvisioningUpdates
      
    - name: Export iOS IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/LoRaCueManager-iOS.xcarchive \
          -exportPath ./build/iOS \
          -exportOptionsPlist .github/workflows/ExportOptions-iOS.plist \
          -allowProvisioningUpdates
      
    - name: Upload iOS to App Store Connect
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file ./build/iOS/LoRaCueManager.ipa \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
      
    - name: Build and Archive macOS (arm64)
      run: |
        xcodebuild archive \
          -project LoRaCueManager.xcodeproj \
          -scheme LoRaCueManager \
          -destination "generic/platform=macOS,variant=Mac Catalyst" \
          -archivePath ./build/LoRaCueManager-macOS-arm64.xcarchive \
          -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8 \
          -authenticationKeyID ${{ secrets.APPSTORE_KEY_ID }} \
          -authenticationKeyIssuerID ${{ secrets.APPSTORE_ISSUER_ID }} \
          ONLY_ACTIVE_ARCH=NO \
          MARKETING_VERSION=${{ steps.version.outputs.version }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
          -allowProvisioningUpdates
      
    - name: Build and Archive macOS (x86_64)
      run: |
        xcodebuild archive \
          -project LoRaCueManager.xcodeproj \
          -scheme LoRaCueManager \
          -destination "generic/platform=macOS,variant=Mac Catalyst,arch=x86_64" \
          -archivePath ./build/LoRaCueManager-macOS-x86_64.xcarchive \
          -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.APPSTORE_KEY_ID }}.p8 \
          -authenticationKeyID ${{ secrets.APPSTORE_KEY_ID }} \
          -authenticationKeyIssuerID ${{ secrets.APPSTORE_ISSUER_ID }} \
          ONLY_ACTIVE_ARCH=NO \
          MARKETING_VERSION=${{ steps.version.outputs.version }} \
          CURRENT_PROJECT_VERSION=${{ steps.version.outputs.build_number }} \
          -allowProvisioningUpdates
      
    - name: Create Universal Binary
      run: |
        # Extract apps from archives
        cp -R ./build/LoRaCueManager-macOS-arm64.xcarchive/Products/Applications/LoRaCueManager.app ./build/LoRaCueManager-arm64.app
        cp -R ./build/LoRaCueManager-macOS-x86_64.xcarchive/Products/Applications/LoRaCueManager.app ./build/LoRaCueManager-x86_64.app
        
        # Create universal app bundle
        cp -R ./build/LoRaCueManager-arm64.app ./build/LoRaCueManager.app
        
        # Create universal binary using lipo
        lipo -create \
          ./build/LoRaCueManager-arm64.app/Contents/MacOS/LoRaCueManager \
          ./build/LoRaCueManager-x86_64.app/Contents/MacOS/LoRaCueManager \
          -output ./build/LoRaCueManager.app/Contents/MacOS/LoRaCueManager
        
        # Verify universal binary
        lipo -info ./build/LoRaCueManager.app/Contents/MacOS/LoRaCueManager
      
    - name: Create DMG
      run: |
        # Install create-dmg
        brew install create-dmg
        
        # Create DMG (unsigned for now - will add Developer ID signing later)
        create-dmg \
          --volname "LoRaCue Manager" \
          --volicon "./LoRaCueManager/Assets.xcassets/AppIcon.appiconset/icon_512x512.png" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "LoRaCueManager.app" 200 190 \
          --hide-extension "LoRaCueManager.app" \
          --app-drop-link 600 185 \
          "./LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg" \
          "./build/LoRaCueManager.app" || true
        
        # Fallback if create-dmg fails
        if [ ! -f "./LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg" ]; then
          hdiutil create -volname "LoRaCue Manager" \
            -srcfolder ./build/LoRaCueManager.app \
            -ov -format UDZO \
            "./LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg"
        fi
      
    - name: Upload macOS to App Store Connect
      run: |
        # Export for App Store
        xcodebuild -exportArchive \
          -archivePath ./build/LoRaCueManager-macOS-arm64.xcarchive \
          -exportPath ./build/macOS-AppStore \
          -exportOptionsPlist .github/workflows/ExportOptions-macOS.plist \
          -allowProvisioningUpdates
        
        xcrun altool --upload-app \
          --type macos \
          --file ./build/macOS-AppStore/LoRaCueManager.pkg \
          --apiKey ${{ secrets.APPSTORE_KEY_ID }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
      
    - name: Get build timestamp
      id: timestamp
      run: echo "date=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$GITHUB_OUTPUT"
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          LoRaCueManager-iOS-${{ steps.version.outputs.version }}.ipa
          LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg
        body: |
          ${{ needs.generate-changelog.outputs.breaking_changes != '' && format('# ‚ö†Ô∏è BREAKING CHANGES{0}{0}{1}{0}{0}', '\n', needs.generate-changelog.outputs.breaking_changes) || '' }}
          # üì± LoRaCue Manager v${{ steps.version.outputs.version }}
          
          Cross-platform device management application for LoRaCue devices.
          
          ## üì¶ Downloads
          
          | Platform | File | Requirements |
          |----------|------|--------------|
          | **iOS/iPadOS** | [LoRaCueManager-iOS-${{ steps.version.outputs.version }}.ipa](https://github.com/LoRaCue/loracue-manager-apple/releases/download/${{ github.ref_name }}/LoRaCueManager-iOS-${{ steps.version.outputs.version }}.ipa) | iOS 17.0+ |
          | **macOS** | [LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg](https://github.com/LoRaCue/loracue-manager-apple/releases/download/${{ github.ref_name }}/LoRaCueManager-macOS-${{ steps.version.outputs.version }}.dmg) | macOS 14.0+ (Universal: Apple Silicon + Intel) |
          
          ## üì• Installation
          
          ### iOS/iPadOS
          - Download via TestFlight (recommended)
          - Or sideload the .ipa file using AltStore or similar tools
          
          ### macOS
          - Download and open the .dmg file
          - Drag LoRaCue Manager to your Applications folder
          - Grant Bluetooth permissions when prompted
          - **Universal Binary**: Runs natively on both Apple Silicon and Intel Macs
          
          ## ‚ú® Features
          
          - üîµ **Bluetooth LE** - Wireless device management
          - üîå **USB-CDC Serial** - Direct wired connection (macOS only)
          - ‚öôÔ∏è **Device Configuration** - General, power, and LoRa radio settings
          - üîÑ **Firmware Updates** - Over-the-air firmware upgrades
          - üíæ **Favorites** - Quick access to frequently used devices
          - üåê **Localized** - Multi-language support ready
          
          # üîÑ Changelog
          
          ${{ needs.generate-changelog.outputs.changelog }}
          
          # üõ†Ô∏è Technical Details
          
          - **Build Date**: ${{ steps.timestamp.outputs.date }}
          - **Build Number**: ${{ steps.version.outputs.build_number }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Xcode**: 15.0+
          - **Swift**: 5.9+
          - **macOS**: Universal Binary (arm64 + x86_64)
          
          ## üìö Documentation
          
          - **Repository**: https://github.com/LoRaCue/loracue-manager-apple
          - **Issues**: https://github.com/LoRaCue/loracue-manager-apple/issues
          - **Firmware**: https://github.com/LoRaCue/loracue
          
          ---
          
          **üèôÔ∏è Made with ‚ù§Ô∏è in Hannover üá©üá™**
        draft: false
        prerelease: ${{ steps.version.outputs.is_prerelease }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
